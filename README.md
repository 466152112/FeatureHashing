FeatureHashing
==============

Implement feature hashing with R

## Demo

### Hashed Matrix


```r
library(FeatureHashing)
# create a "CSRMatrix"
m1 <- hashed.model.matrix(~ ., data = CO2, hash_size = 2^4)
```

```
## original feature size is 16
## estimated collision rate is 0.00000000
```

```r
# the structure is similar to "Matrix::dgCMatrix"
library(Matrix)
m2 <- sparse.model.matrix(~ ., data = CO2, transpose = TRUE)
str(m1)
```

```
## Formal class 'CSRMatrix' [package "FeatureHashing"] with 6 slots
##   ..@ i       : int [1:1260] 0 14 7 15 6 0 10 12 13 11 ...
##   ..@ p       : int [1:85] 0 14 28 42 56 70 84 98 112 126 ...
##   ..@ Dim     : int [1:2] 16 84
##   ..@ Dimnames:List of 2
##   .. ..$ : chr(0) 
##   .. ..$ : chr [1:84] "1" "2" "3" "4" ...
##   ..@ x       : num [1:1260] 1 -0.46 0.502 -0.46 0.369 ...
##   ..@ factors : list()
```

```r
str(m2)
```

```
## Formal class 'dgCMatrix' [package "Matrix"] with 6 slots
##   ..@ i       : int [1:1260] 0 1 2 3 4 5 6 7 8 9 ...
##   ..@ p       : int [1:85] 0 14 28 42 56 70 84 98 112 126 ...
##   ..@ Dim     : int [1:2] 16 84
##   ..@ Dimnames:List of 2
##   .. ..$ : chr [1:16] "(Intercept)" "Plant.L" "Plant.Q" "Plant.C" ...
##   .. ..$ : chr [1:84] "1" "2" "3" "4" ...
##   ..@ x       : num [1:1260] 1 -0.46 0.502 -0.46 0.369 ...
##   ..@ factors : list()
```

```r
# You can convert "CSRMatrix" to "Matrix::dgCMatrix" if you want ot use advanced API
m3 <- as(m1, "dgCMatrix")
# As you can see, the hashing trick maps the feature to the space {1, 2, ..., 2^4}
dim(m1)
```

```
## [1] 16 84
```

```r
# The hashing algorithm is crc32 https://en.wikipedia.org/wiki/Cyclic_redundancy_check
FeatureHashing:::hash_without_intercept(letters)
```

```
##  [1]  -390611389  1908338681   112844655 -1730327860  -270894502
##  [6]  1993550816    30677878 -1855256857  -429115791  2137352139
## [11]   140662621 -1777941762  -519966104  2013832146   252678980
## [16] -2113429839  -184504793  1812594589   453955339 -2056627544
## [21]  -227710402  1801730948   476252946 -1931733373   -69523947
## [26]  1657960367
```

```r
# Note that the string "(Intercept)" will always be map to 1
# The hashed.model.matrix hashes the rownames generated by sparse.model.matrix
# So far, "CSRMatrix" only supports matrix-vector multiplication
v <- rnorm(2^4)
all.equal(v %*% m1, as.vector(v %*% m3))
```

```
## [1] TRUE
```

```r
# However, the computation speed of "CSRMatrix" should be faster
library(rbenchmark)
```

```
## Error: there is no package called 'rbenchmark'
```

```r
benchmark(v %*% m1, v %*% m3)
```

```
## Error: could not find function "benchmark"
```

### Tag Feature


```r
library(FeatureHashing)
# I also implemented some function to handle tag features
data1 <- data.frame(a = c("1,2,3", "2,3,3", "1,3", "3"), type = c("a", "b", "a", "a"), stringsAsFactors = FALSE)
# The column a is a tag feature whose seperator is ","
# To generate the corresponding model matrix, there are two helper functions: tag and interpret.tag

# tag function expands the tag feature to count or existence
tag(data1$a, split = ",", type = "count")
```

```
## $`1`
## [1] 1 0 1 0
## 
## $`2`
## [1] 1 1 0 0
## 
## $`3`
## [1] 1 2 1 1
## 
## attr(,"type")
## [1] "count"
```

```r
tag(data1$a, split = ",", type = "existence")
```

```
## $`1`
## [1]  TRUE FALSE  TRUE FALSE
## 
## $`2`
## [1]  TRUE  TRUE FALSE FALSE
## 
## $`3`
## [1] TRUE TRUE TRUE TRUE
## 
## attr(,"type")
## [1] "existence"
```

```r
# interpret.tag expands the formula and data.frame
retval <- interpret.tag(~ tag(a, split = ",", type = "count") * type + type * tag(a, split = ",", type = "existence"), data = data1)

# the return list has object(formula) and data
# the object is the expand formula from tag
retval$object
```

```
## ~a_count__1 + a_count__2 + a_count__3 + type + a_existence__1 + 
##     a_existence__2 + a_existence__3 + a_count__1:type + a_count__2:type + 
##     a_count__3:type + type:a_existence__1 + type:a_existence__2 + 
##     type:a_existence__3
```

```r
# the data is the data.frame fetch the expanded tag features
retval$data
```

```
##       a type a_count__1 a_count__2 a_count__3 a_existence__1
## 1 1,2,3    a          1          1          1           TRUE
## 2 2,3,3    b          0          1          2          FALSE
## 3   1,3    a          1          0          1           TRUE
## 4     3    a          0          0          1          FALSE
##   a_existence__2 a_existence__3
## 1           TRUE           TRUE
## 2           TRUE           TRUE
## 3          FALSE           TRUE
## 4          FALSE           TRUE
```

```r
# We could evaluate the model matrix from the result of interpret.tag
model.matrix(retval$object, data = retval$data)
```

```
##   (Intercept) a_count__1 a_count__2 a_count__3 typeb a_existence__1TRUE
## 1           1          1          1          1     0                  1
## 2           1          0          1          2     1                  0
## 3           1          1          0          1     0                  1
## 4           1          0          0          1     0                  0
##   a_existence__2TRUE a_existence__3TRUE a_count__1:typeb a_count__2:typeb
## 1                  1                  1                0                0
## 2                  1                  1                0                1
## 3                  0                  1                0                0
## 4                  0                  1                0                0
##   a_count__3:typeb typeb:a_existence__1TRUE typeb:a_existence__2TRUE
## 1                0                        0                        0
## 2                2                        0                        1
## 3                0                        0                        0
## 4                0                        0                        0
##   typeb:a_existence__3TRUE
## 1                        0
## 2                        1
## 3                        0
## 4                        0
## attr(,"assign")
##  [1]  0  1  2  3  4  5  6  7  8  9 10 11 12 13
## attr(,"contrasts")
## attr(,"contrasts")$type
## [1] "contr.treatment"
## 
## attr(,"contrasts")$a_existence__1
## [1] "contr.treatment"
## 
## attr(,"contrasts")$a_existence__2
## [1] "contr.treatment"
## 
## attr(,"contrasts")$a_existence__3
## [1] "contr.treatment"
```
